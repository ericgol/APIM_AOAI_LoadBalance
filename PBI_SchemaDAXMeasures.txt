// === POWER BI DATA MODEL SCHEMA ===

// Table: APIM_Usage_Daily
// Connect to your KQL query using the "Export query for Power BI" from the KQL artifact
// Expected columns from KQL:
// - date (datetime)
// - client_id (text) 
// - tenant_id (text)
// - cost_tier (text)
// - total_calls (whole number)
// - successful_calls (whole number)  
// - failed_calls (whole number)
// - avg_response_time_ms (decimal number)
// - max_response_time_ms (decimal number)
// - p95_response_time_ms (decimal number)
// - total_estimated_cost (decimal number)
// - unique_apis (whole number)
// - unique_operations (whole number)
// - success_rate_percent (decimal number)
// - avg_cost_per_call (decimal number)

// === CALCULATED COLUMNS ===

// Add these calculated columns to your APIM_Usage_Daily table:

// Year-Month for time grouping
YearMonth = FORMAT(APIM_Usage_Daily[date], "YYYY-MM")

// Client Name (map client IDs to friendly names)
Client Name = 
SWITCH(
    APIM_Usage_Daily[client_id],
    "12345678-1234-1234-1234-123456789abc", "Marketing App",
    "87654321-4321-4321-4321-cba987654321", "Sales Dashboard", 
    "11111111-2222-3333-4444-555555555555", "Mobile App",
    "Unknown: " & APIM_Usage_Daily[client_id]
)

// Cost Category for easier reporting
Cost Category = 
SWITCH(
    APIM_Usage_Daily[cost_tier],
    "basic", "Basic (0.5x)",
    "standard", "Standard (1x)", 
    "premium", "Premium (3x)",
    "enterprise", "Enterprise (5x)",
    "Unknown"
)

// Performance Rating based on avg response time
Performance Rating = 
SWITCH(
    TRUE(),
    APIM_Usage_Daily[avg_response_time_ms] <= 100, "Excellent",
    APIM_Usage_Daily[avg_response_time_ms] <= 300, "Good", 
    APIM_Usage_Daily[avg_response_time_ms] <= 1000, "Fair",
    "Poor"
)

// === DAX MEASURES ===

// Total API Calls across all selected data
Total API Calls = SUM(APIM_Usage_Daily[total_calls])

// Total Estimated Cost
Total Cost = 
FORMAT(
    SUM(APIM_Usage_Daily[total_estimated_cost]),
    "$#,##0.00"
)

// Average Response Time (weighted by call volume)
Avg Response Time = 
DIVIDE(
    SUMX(APIM_Usage_Daily, APIM_Usage_Daily[avg_response_time_ms] * APIM_Usage_Daily[total_calls]),
    SUM(APIM_Usage_Daily[total_calls])
)

// Overall Success Rate
Success Rate = 
DIVIDE(
    SUM(APIM_Usage_Daily[successful_calls]),
    SUM(APIM_Usage_Daily[total_calls])
) * 100

// Monthly Growth Rate
Monthly Growth = 
VAR CurrentMonth = SUM(APIM_Usage_Daily[total_calls])
VAR PreviousMonth = 
    CALCULATE(
        SUM(APIM_Usage_Daily[total_calls]),
        DATEADD(APIM_Usage_Daily[date], -1, MONTH)
    )
RETURN
    DIVIDE(CurrentMonth - PreviousMonth, PreviousMonth) * 100

// Cost per 1000 calls
Cost Per 1K Calls = 
DIVIDE(
    SUM(APIM_Usage_Daily[total_estimated_cost]) * 1000,
    SUM(APIM_Usage_Daily[total_calls])
)

// Top Client by Cost
Top Client = 
VAR TopClientCost = 
    TOPN(
        1,
        SUMMARIZE(
            APIM_Usage_Daily,
            APIM_Usage_Daily[Client Name],
            "TotalCost", SUM(APIM_Usage_Daily[total_estimated_cost])
        ),
        [TotalCost],
        DESC
    )
RETURN
    CONCATENATEX(TopClientCost, APIM_Usage_Daily[Client Name])

// Days with data
Days with Data = DISTINCTCOUNT(APIM_Usage_Daily[date])

// Average Daily Cost
Avg Daily Cost = 
DIVIDE(
    SUM(APIM_Usage_Daily[total_estimated_cost]),
    [Days with Data]
)

// Cost Trend (compared to previous period)
Cost Trend = 
VAR CurrentPeriodCost = SUM(APIM_Usage_Daily[total_estimated_cost])
VAR PreviousPeriodCost = 
    CALCULATE(
        SUM(APIM_Usage_Daily[total_estimated_cost]),
        DATEADD(APIM_Usage_Daily[date], -30, DAY)
    )
VAR TrendPercentage = 
    IF(
        PreviousPeriodCost > 0,
        DIVIDE(CurrentPeriodCost - PreviousPeriodCost, PreviousPeriodCost) * 100,
        BLANK()
    )
RETURN
    IF(
        TrendPercentage > 5, "📈 Up " & FORMAT(TrendPercentage, "0.0") & "%",
        IF(TrendPercentage < -5, "📉 Down " & FORMAT(ABS(TrendPercentage), "0.0") & "%", "➡️ Stable")
    )

// Health Score (composite metric)
API Health Score = 
VAR SuccessScore = MIN([Success Rate] / 100 * 40, 40)
VAR PerformanceScore = 
    SWITCH(
        TRUE(),
        [Avg Response Time] <= 100, 35,
        [Avg Response Time] <= 300, 25,
        [Avg Response Time] <= 1000, 15,
        5
    )
VAR UsageScore = MIN(SUM(APIM_Usage_Daily[total_calls]) / 10000 * 25, 25)
RETURN
    ROUND(SuccessScore + PerformanceScore + UsageScore, 0)

// === REPORT LAYOUT SUGGESTIONS ===

/*
PAGE 1: Executive Dashboard
- Card visuals: Total Cost, Total API Calls, Success Rate, Avg Response Time
- Line chart: Daily cost trend over time
- Donut chart: Cost by tier  
- Bar chart: Top 10 clients by cost
- KPI: Cost Trend with previous period comparison

PAGE 2: Client Analysis  
- Table: Client breakdown with calls, cost, success rate
- Stacked bar chart: Calls by client and cost tier
- Scatter plot: Avg response time vs total calls by client
- Slicer: Client name filter

PAGE 3: Performance Monitoring
- Line chart: Response time trends
- Heatmap: Success rate by client and day
- Gauge: API Health Score
- Table: Performance rating distribution

PAGE 4: Cost Analysis
- Waterfall chart: Cost breakdown by tier
- Area chart: Cumulative cost over time  
- Matrix: Cost by client and month
- Card: Cost per 1K calls

Refresh: Set up scheduled refresh from your Log Analytics workspace
Filters: Add date range picker and client/tier slicers on each page
*/